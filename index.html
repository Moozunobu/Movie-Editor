<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Professional Video Editor - Resize & Audio Fix</title>
    <style>
        :root {
            --bg: #0f0f0f; --panel: #1a1a1a; --accent: #007aff; --red: #ff3b30; --text: #eee; --border: #2a2a2a;
        }
        body {
            background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif;
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            user-select: none; -webkit-user-select: none;
        }

        /* „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„ÉàÔºà‰∏äÈÉ®Ôºâ */
        #top-area { display: flex; flex: 1; min-height: 0; overflow: hidden; }
        
        #library-sidebar { width: 240px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 15px; }
        #preview-section { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; position: relative; }
        #inspector-sidebar { width: 280px; background: var(--panel); border-left: 1px solid var(--border); padding: 20px; overflow-y: auto; }

        canvas { max-width: 95%; max-height: 70%; background: #000; box-shadow: 0 10px 50px rgba(0,0,0,0.8); touch-action: none; }
        #time-display { font-family: monospace; font-size: 24px; color: var(--accent); margin-bottom: 10px; }

        /* „É™„Çµ„Ç§„Ç∂„ÉºÔºàÂ¢ÉÁïåÁ∑öÔºâ */
        #timeline-resizer {
            height: 8px; background: var(--border); cursor: row-resize; width: 100%;
            transition: background 0.2s; z-index: 1000;
        }
        #timeline-resizer:hover { background: var(--accent); }

        /* „Çø„Ç§„É†„É©„Ç§„É≥Ôºà‰∏ãÈÉ®Ôºâ */
        #timeline-container { height: 350px; min-height: 150px; background: #111; position: relative; overflow: hidden; }
        #time-ruler { height: 35px; background: #1a1a1a; border-bottom: 1px solid var(--border); position: relative; touch-action: none; }
        #track-area { position: relative; height: calc(100% - 35px); overflow-x: auto; overflow-y: auto; touch-action: pan-x; }
        .track { height: 70px; border-bottom: 1px solid #222; position: relative; width: 5000px; display: flex; align-items: center; }

        /* „ÇØ„É™„ÉÉ„Éó */
        .clip {
            position: absolute; height: 50px; background: var(--accent);
            border-radius: 6px; color: white; display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: bold; touch-action: none; cursor: pointer;
        }
        .clip.text { background: #5856d6; }
        .clip.audio { background: #34c759; }
        .clip.selected { outline: 3px solid white; z-index: 10; box-shadow: 0 0 20px var(--accent); }
        .handle { position: absolute; top: 0; width: 25px; height: 100%; background: rgba(255,255,255,0.15); cursor: ew-resize; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .handle-l { left: 0; border-radius: 6px 0 0 6px; }
        .handle-r { right: 0; border-radius: 0 6px 6px 0; }

        /* ÂÜçÁîü„Éò„ÉÉ„Éâ */
        #playhead { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--red); z-index: 100; pointer-events: none; }
        #playhead-handle {
            position: absolute; top: 0; left: -20px; width: 40px; height: 35px;
            cursor: grab; z-index: 101; display: flex; justify-content: center; touch-action: none;
        }
        #playhead-handle::after { content: ''; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 15px solid var(--red); }

        /* „Ç≥„É≥„Éà„É≠„Éº„É´Áæ§ */
        .toolbar { display: flex; gap: 20px; margin-top: 15px; align-items: center; }
        .btn-play {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            background: var(--accent); color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn-play svg { width: 30px; height: 30px; fill: currentColor; }
        .btn-split { width: 44px; height: 44px; border-radius: 50%; border: 1px solid #333; background: #222; color: var(--red); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-rect { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; margin-bottom: 8px; cursor: pointer; font-size: 11px; }

        #asset-list { flex: 1; overflow-y: auto; margin-top: 10px; font-size: 11px; color: #666; }
        .asset-item { padding: 10px; border-bottom: 1px solid #222; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .ui-group { margin-bottom: 15px; }
        .ui-group label { display: block; font-size: 10px; color: #666; margin-bottom: 5px; text-transform: uppercase; }
        input[type="text"], select { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 6px; }
    </style>
</head>
<body>

<div id="top-area">
    <div id="library-sidebar">
        <h3 style="font-size:10px; letter-spacing:1px; color:#555;">LIBRARY</h3>
        <div id="asset-list">No media</div>
        <button class="btn-rect" style="margin-top:15px" onclick="document.getElementById('fileInp').click()">+ VIDEO</button>
        <button class="btn-rect" style="background:#444" onclick="document.getElementById('audioInp').click()">+ MP3</button>
        <button class="btn-rect" style="background:#444" onclick="addText()">+ TEXT</button>
        <input type="file" id="fileInp" hidden accept="video/*" multiple>
        <input type="file" id="audioInp" hidden accept="audio/mp3,audio/wav" multiple>
    </div>

    <div id="preview-section">
        <div id="time-display">00:00.00</div>
        <canvas id="mainCanvas"></canvas>
        <div class="toolbar">
            <button class="btn-split" id="btnSplit"><svg viewBox="0 0 24 24"><path d="M21 2l-2 2-7.79 7.79-3.12-3.12L3 14l5 5 4.49-4.49L17 19l5-5-1-1z"/></svg></button>
            <button class="btn-play" id="btnPlay">
                <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                <svg id="pauseIcon" style="display:none;" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
            <div style="background:#222; padding:8px 12px; border-radius:25px; display:flex; align-items:center; gap:8px;">
                <input type="range" id="speedRange" min="0.5" max="2.0" step="0.1" value="1.0" style="width:50px">
                <span id="speedLabel" style="font-size:11px; color:var(--accent)">1.0x</span>
            </div>
        </div>
    </div>

    <div id="inspector-sidebar">
        <h3 style="font-size:10px; letter-spacing:1px; color:#555;">INSPECTOR</h3>
        <div id="edit-controls" style="display:none; margin-top:20px;">
            <div id="text-only">
                <div class="ui-group"><label>Text</label><input type="text" id="inpText"></div>
                <div class="ui-group"><label>Size</label><input type="range" id="inpSize" min="10" max="500" value="80"></div>
                <div style="display:flex; gap:10px">
                    <div class="ui-group" style="flex:1"><label>Fill</label><input type="color" id="inpColor"></div>
                    <div class="ui-group" style="flex:1"><label>Stroke</label><input type="color" id="inpStroke"></div>
                </div>
            </div>
            <div class="ui-group">
                <label>Effect</label>
                <select id="inpEffect">
                    <option value="none">None</option>
                    <option value="grayscale(100%)">Gray</option>
                    <option value="sepia(100%)">Sepia</option>
                    <option value="blur(10px)">Blur</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div id="timeline-resizer"></div>

<div id="timeline-container">
    <div id="time-ruler"><div id="playhead-handle"></div></div>
    <div id="track-area">
        <div id="playhead"></div>
        <div class="track" id="textTrack"></div>
        <div class="track" id="videoTrack"></div>
        <div class="track" id="audioTrack"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const timeDisplay = document.getElementById('time-display');
    const playhead = document.getElementById('playhead');
    const phHandle = document.getElementById('playhead-handle');
    const trackArea = document.getElementById('track-area');
    const resizer = document.getElementById('timeline-resizer');
    const timelineContainer = document.getElementById('timeline-container');
    
    let clips = [];
    let selectedClip = null;
    let currentTime = 0;
    let isPlaying = false;
    let playbackRate = 1.0;
    let pixelsPerSecond = 60;

    // --- „Çø„Ç§„É†„É©„Ç§„É≥„ÅÆ„É™„Çµ„Ç§„Ç∫Ê©üËÉΩ ---
    resizer.onpointerdown = (e) => {
        e.preventDefault();
        const onMove = (me) => {
            const newHeight = window.innerHeight - me.clientY;
            timelineContainer.style.height = Math.max(150, Math.min(newHeight, window.innerHeight * 0.7)) + "px";
            updatePlayheadUI();
        };
        const onUp = () => { window.removeEventListener('pointermove', onMove); };
        window.addEventListener('pointermove', onMove);
        window.addEventListener('pointerup', onUp, {once:true});
    };

    class Clip {
        constructor(id, type, source, duration, trackId) {
            this.id = id; this.type = type; this.source = source;
            this.start = 0; this.duration = duration; this.offset = 0;
            this.trackId = trackId; this.effect = "none";
            this.text = "Text"; this.x = 640; this.y = 360; this.size = 80;
            this.color = "#ffffff"; this.stroke = "#000000";
            this.dom = this.createDOM();
        }
        createDOM() {
            const div = document.createElement('div');
            div.className = `clip ${this.type}`;
            div.innerHTML = `<div class="handle handle-l"></div><span></span><div class="handle handle-r"></div>`;
            div.addEventListener('pointerdown', (e) => {
                if (e.target.classList.contains('handle')) return;
                e.stopPropagation(); selectClip(this);
                const startX = e.clientX, startT = this.start;
                const onMove = (me) => { this.start = Math.max(0, startT + (me.clientX - startX) / pixelsPerSecond); this.updateUI(); render(); };
                window.addEventListener('pointermove', onMove);
                window.addEventListener('pointerup', () => window.removeEventListener('pointermove', onMove), {once:true});
            });
            div.querySelector('.handle-l').addEventListener('pointerdown', (e) => {
                e.stopPropagation();
                const startX = e.clientX, startT = this.start, startDur = this.duration, startOff = this.offset;
                const onMove = (me) => {
                    const diff = (me.clientX - startX) / pixelsPerSecond;
                    const realDiff = Math.min(diff, startDur - 0.1);
                    this.start = startT + realDiff; this.duration = startDur - realDiff;
                    if (this.type !== 'text') this.offset = startOff + realDiff;
                    this.updateUI(); render();
                };
                window.addEventListener('pointermove', onMove);
                window.addEventListener('pointerup', () => window.removeEventListener('pointermove', onMove), {once:true});
            });
            div.querySelector('.handle-r').addEventListener('pointerdown', (e) => {
                e.stopPropagation();
                const startX = e.clientX, startDur = this.duration;
                const onMove = (me) => { this.duration = Math.max(0.1, startDur + (me.clientX - startX) / pixelsPerSecond); this.updateUI(); render(); };
                window.addEventListener('pointermove', onMove);
                window.addEventListener('pointerup', () => window.removeEventListener('pointermove', onMove), {once:true});
            });
            return div;
        }
        updateUI() {
            this.dom.style.left = (this.start * pixelsPerSecond) + "px";
            this.dom.style.width = (this.duration * pixelsPerSecond) + "px";
            const icon = this.type === 'video' ? 'üé¨' : (this.type === 'audio' ? 'üéµ' : 'T');
            this.dom.querySelector('span').innerText = `${icon} ${this.type==='text'?this.text:''}`;
        }
    }

    // ÊñáÂ≠óÁßªÂãï
    canvas.addEventListener('pointerdown', (e) => {
        if (!selectedClip || selectedClip.type !== 'text') return;
        const rect = canvas.getBoundingClientRect(), scale = canvas.width / rect.width;
        const onMove = (me) => { selectedClip.x = (me.clientX - rect.left) * scale; selectedClip.y = (me.clientY - rect.top) * scale; render(); };
        window.addEventListener('pointermove', onMove);
        window.addEventListener('pointerup', () => window.removeEventListener('pointermove', onMove), {once:true});
    });

    // „Çø„Ç§„É†„Ç≥„Éº„Éâ
    function formatTime(sec) {
        const m = Math.floor(sec / 60).toString().padStart(2, '0');
        const s = Math.floor(sec % 60).toString().padStart(2, '0');
        const ms = Math.floor((sec % 1) * 100).toString().padStart(2, '0');
        return `${m}:${s}.${ms}`;
    }

    // ÂÜçÁîü„Éò„ÉÉ„Éâ
    phHandle.onpointerdown = (e) => {
        e.stopPropagation(); stopAllMedia();
        const onMove = (me) => {
            const rect = document.getElementById('time-ruler').getBoundingClientRect();
            currentTime = Math.max(0, (me.clientX - rect.left + trackArea.scrollLeft) / pixelsPerSecond);
            updatePlayheadUI(); render();
        };
        window.addEventListener('pointermove', onMove);
        window.addEventListener('pointerup', () => window.removeEventListener('pointermove', onMove), {once:true});
    };

    function updatePlayheadUI() {
        const x = currentTime * pixelsPerSecond;
        playhead.style.left = x + "px";
        phHandle.style.left = (x - trackArea.scrollLeft) + "px";
        timeDisplay.innerText = formatTime(currentTime);
    }
    trackArea.onscroll = updatePlayheadUI;

    // „Ç§„É≥„Éù„Éº„Éà
    function addAsset(file, type, trackId) {
        const el = document.createElement(type === 'video' ? 'video' : 'audio');
        el.src = URL.createObjectURL(file); el.muted = (type === 'video');
        el.onloadedmetadata = () => {
            const clip = new Clip(Date.now(), type, el, el.duration, trackId);
            clip.start = currentTime; clips.push(clip);
            document.getElementById(trackId).appendChild(clip.dom);
            clip.updateUI(); render();
            const item = document.createElement('div');
            item.className = "asset-item"; item.innerText = `${type==='video'?'üé¨':'üéµ'} ${file.name}`;
            document.getElementById('asset-list').appendChild(item);
        };
    }
    document.getElementById('fileInp').onchange = (e) => { for(let f of e.target.files) addAsset(f, 'video', 'videoTrack'); };
    document.getElementById('audioInp').onchange = (e) => { for(let f of e.target.files) addAsset(f, 'audio', 'audioTrack'); };
    function addText() {
        const clip = new Clip(Date.now(), 'text', null, 5, 'textTrack');
        clip.start = currentTime; clips.push(clip);
        document.getElementById(clip.trackId).appendChild(clip.dom); clip.updateUI(); render();
    }

    function selectClip(clip) {
        if (selectedClip) selectedClip.dom.classList.remove('selected');
        selectedClip = clip; clip.dom.classList.add('selected');
        document.getElementById('edit-controls').style.display = 'block';
        document.getElementById('text-only').style.display = clip.type === 'text' ? 'block' : 'none';
        document.getElementById('inpText').value = clip.text;
        document.getElementById('inpSize').value = clip.size;
        document.getElementById('inpColor').value = clip.color;
        document.getElementById('inpStroke').value = clip.stroke;
        document.getElementById('inpEffect').value = clip.effect;
    }

    ['inpText', 'inpSize', 'inpColor', 'inpStroke', 'inpEffect'].forEach(id => {
        document.getElementById(id).oninput = (e) => {
            if (!selectedClip) return;
            const val = e.target.value;
            if (id === 'inpText') selectedClip.text = val;
            if (id === 'inpSize') selectedClip.size = val;
            if (id === 'inpColor') selectedClip.color = val;
            if (id === 'inpStroke') selectedClip.stroke = val;
            if (id === 'inpEffect') selectedClip.effect = val;
            selectedClip.updateUI(); render();
        };
    });

    // --- Èü≥Â£∞ÂÅúÊ≠¢„Éê„Ç∞‰øÆÊ≠£„É≠„Ç∏„ÉÉ„ÇØ ---
    function stopAllMedia() {
        isPlaying = false;
        togglePlayUI(false);
        clips.forEach(clip => {
            if (clip.type === 'video' || clip.type === 'audio') {
                clip.source.pause();
            }
        });
    }

    function render() {
        if (canvas.width !== 1280) { canvas.width = 1280; canvas.height = 720; }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        clips.forEach(clip => {
            const isActive = currentTime >= clip.start && currentTime <= clip.start + clip.duration;
            
            if (isActive) {
                ctx.save();
                if (clip.effect === 'fade') { 
                    const inT = currentTime - clip.start, outT = (clip.start + clip.duration) - currentTime; 
                    ctx.globalAlpha = Math.min(1, inT/0.5, outT/0.5); 
                } else if (clip.effect !== 'none') ctx.filter = clip.effect;

                if (clip.type === 'video') {
                    clip.source.currentTime = clip.offset + (currentTime - clip.start);
                    ctx.drawImage(clip.source, 0, 0, canvas.width, canvas.height);
                    if (isPlaying && clip.source.paused) clip.source.play();
                } else if (clip.type === 'text') {
                    ctx.font = `bold ${clip.size}px sans-serif`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    ctx.strokeStyle = clip.stroke; ctx.lineWidth = clip.size/8; ctx.strokeText(clip.text, clip.x, clip.y);
                    ctx.fillStyle = clip.color; ctx.fillText(clip.text, clip.x, clip.y);
                } else if (clip.type === 'audio') {
                    if (isPlaying) {
                        const targetTime = clip.offset + (currentTime - clip.start);
                        if (Math.abs(clip.source.currentTime - targetTime) > 0.15) clip.source.currentTime = targetTime;
                        if (clip.source.paused) clip.source.play();
                    } else {
                        clip.source.pause(); // ÂÅúÊ≠¢‰∏≠„ÅØÁ¢∫ÂÆü„Å´Ê≠¢„ÇÅ„Çã
                    }
                }
                ctx.restore();
            } else {
                // ÁØÑÂõ≤Â§ñ„Å™„ÇâÁ¢∫ÂÆü„Å´ÂÅúÊ≠¢
                if ((clip.type === 'audio' || clip.type === 'video') && !clip.source.paused) {
                    clip.source.pause();
                }
            }
        });
    }

    // ÂÜçÁîü„Éú„Çø„É≥
    const btnPlay = document.getElementById('btnPlay');
    function togglePlayUI(playing) {
        document.getElementById('playIcon').style.display = playing ? 'none' : 'block';
        document.getElementById('pauseIcon').style.display = playing ? 'block' : 'none';
        btnPlay.style.background = playing ? 'var(--red)' : 'var(--accent)';
    }

    btnPlay.onclick = () => {
        if (isPlaying) {
            stopAllMedia();
        } else {
            isPlaying = true;
            togglePlayUI(true);
            let last = performance.now();
            const loop = (now) => {
                if (!isPlaying) return;
                currentTime += (now - last) / 1000 * playbackRate;
                last = now; updatePlayheadUI(); render(); requestAnimationFrame(loop);
            };
            requestAnimationFrame(loop);
        }
    };

    document.getElementById('speedRange').oninput = (e) => { 
        playbackRate = parseFloat(e.target.value); 
        document.getElementById('speedLabel').innerText = playbackRate.toFixed(1) + "x"; 
    };

    document.getElementById('btnSplit').onclick = () => {
        if (!selectedClip) return;
        const splitPoint = currentTime - selectedClip.start;
        if (splitPoint <= 0.1 || splitPoint >= selectedClip.duration - 0.1) return;
        const newClip = new Clip(Date.now(), selectedClip.type, selectedClip.source, selectedClip.duration - splitPoint, selectedClip.trackId);
        newClip.start = currentTime; newClip.offset = selectedClip.offset + splitPoint;
        newClip.text = selectedClip.text; newClip.x = selectedClip.x; newClip.y = selectedClip.y; newClip.size = selectedClip.size;
        selectedClip.duration = splitPoint; clips.push(newClip);
        document.getElementById(selectedClip.trackId).appendChild(newClip.dom);
        selectedClip.updateUI(); newClip.updateUI(); render();
    };
</script>

</body>
</html>
