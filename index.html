<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NextGen Web Video Editor</title>
    <style>
        :root {
            --bg-base: #111111;
            --bg-panel: #1e1e1e;
            --bg-header: #252525;
            --accent: #007aff;
            --accent-red: #ff3b30;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --border: #333;
        }

        body {
            background: var(--bg-base);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº„Éª„É¨„Ç§„Ç¢„Ç¶„Éà */
        #top-panel { display: flex; flex: 1; min-height: 0; }
        
        #library-panel { width: 220px; background: var(--bg-panel); border-right: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; }
        #preview-area { flex: 1; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        #inspector-panel { width: 260px; background: var(--bg-panel); border-left: 1px solid var(--border); padding: 20px; overflow-y: auto; }

        /* „Ç≠„É£„É≥„Éê„Çπ */
        canvas {
            max-width: 90%;
            max-height: 80%;
            background: #000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            cursor: crosshair;
        }

        /* „Çø„Ç§„É†„É©„Ç§„É≥ */
        #timeline-section { height: 320px; background: var(--bg-panel); border-top: 1px solid var(--border); position: relative; overflow-x: auto; }
        #timeline-header { height: 40px; background: var(--bg-header); display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid var(--border); sticky: top; }
        
        #timeline-content { position: relative; width: 5000px; height: calc(100% - 40px); }
        .track { height: 70px; border-bottom: 1px solid var(--border); position: relative; width: 100%; display: flex; align-items: center; background: rgba(255,255,255,0.01); }

        /* „ÇØ„É™„ÉÉ„Éó„Éá„Ç∂„Ç§„É≥ */
        .clip {
            position: absolute; height: 54px; background: var(--accent); border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1); overflow: hidden; color: white;
            font-size: 11px; display: flex; align-items: center; padding: 0 10px; cursor: pointer;
        }
        .clip.text { background: #5856d6; }
        .clip.selected { outline: 2px solid white; box-shadow: 0 0 15px rgba(0,122,255,0.5); z-index: 10; }
        .handle-r { position: absolute; right: 0; width: 12px; height: 100%; background: rgba(0,0,0,0.1); cursor: ew-resize; }

        /* ÂÜçÁîü„Éò„ÉÉ„Éâ */
        #playhead {
            position: absolute; top: 0; bottom: 0; width: 2px; background: var(--accent-red); z-index: 1000; pointer-events: none;
        }
        #playhead-handle {
            position: absolute; top: 0; left: -10px; width: 20px; height: 20px; 
            background: var(--accent-red); clip-path: polygon(0 0, 100% 0, 50% 100%); cursor: grab;
        }

        /* Ê¥óÁ∑¥„Åï„Çå„Åü„Éú„Çø„É≥„Éª„Ç≥„É≥„Éà„É≠„Éº„É´ */
        .tool-bar { display: flex; gap: 15px; margin-top: 15px; align-items: center; }
        .icon-btn {
            background: transparent; border: 1px solid var(--border); color: var(--text-main);
            width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .icon-btn:hover { background: var(--border); }
        .icon-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .icon-btn.active { color: var(--accent); border-color: var(--accent); }

        .btn-primary {
            background: var(--accent); color: white; border: none; padding: 10px;
            border-radius: 6px; width: 100%; font-weight: 600; cursor: pointer; margin-bottom: 10px;
        }

        /* „Ç§„É≥„Çπ„Éö„ÇØ„ÇøÂÖ•Âäõ */
        .field { margin-bottom: 15px; }
        .field label { display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 5px; text-transform: uppercase; }
        .field input, .field select {
            width: 100%; background: #000; border: 1px solid var(--border); color: white;
            padding: 8px; border-radius: 4px; box-sizing: border-box; font-size: 13px;
        }
    </style>
</head>
<body>

<div id="top-panel">
    <!-- „É©„Ç§„Éñ„É©„É™ -->
    <div id="library-panel">
        <h4 style="margin:0 0 15px 0; font-size:13px; letter-spacing: 1px;">ASSETS</h4>
        <div id="mediaStats" style="font-size:11px; color:var(--text-dim); margin-bottom:10px;">ÂãïÁîª: 0Êú¨</div>
        <div id="mediaList" style="flex:1; font-size:12px; overflow-y:auto;"></div>
        <button class="btn-primary" onclick="document.getElementById('fileVideo').click()">+ IMPORT VIDEO</button>
        <button class="btn-primary" style="background:#444" onclick="addText()">+ ADD TEXT</button>
        <input type="file" id="fileVideo" hidden accept="video/*" multiple>
    </div>

    <!-- „Éó„É¨„Éì„É•„Éº -->
    <div id="preview-area">
        <canvas id="mainCanvas"></canvas>
        <div class="tool-bar">
            <!-- ÂÜçÁîüÈÄüÂ∫¶ -->
            <div style="display:flex; align-items:center; gap:8px;">
                <span style="font-size:10px; color:var(--text-dim)">SPEED</span>
                <input type="range" id="speedRange" min="0.5" max="2" step="0.1" value="1" style="width:80px;">
                <span id="speedVal" style="font-size:10px; width:25px;">1.0x</span>
            </div>
            <!-- ÂÜçÁîü„Éú„Çø„É≥ -->
            <button class="icon-btn" id="btnPlay">
                <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <!-- ÂàÜÂâ≤„Éú„Çø„É≥ -->
            <button class="icon-btn" id="btnSplit" title="Split">
                <svg viewBox="0 0 24 24"><path d="M21 2l-2 2-7.79 7.79-3.12-3.12L3 14l5 5 4.49-4.49L17 19l5-5-1-1z"/></svg>
            </button>
        </div>
    </div>
    
    <!-- „Ç§„É≥„Çπ„Éö„ÇØ„Çø -->
    <div id="inspector-panel">
        <h4 style="margin:0 0 20px 0; font-size:13px; letter-spacing: 1px;">INSPECTOR</h4>
        <div id="no-selection" style="color:var(--text-dim); text-align:center; margin-top:50px;">Select a clip to edit</div>
        
        <div id="controls" style="display:none">
            <div class="field">
                <label>Effect</label>
                <select id="inspectEffect">
                    <option value="none">None</option>
                    <option value="grayscale(100%)">Monochrome</option>
                    <option value="sepia(100%)">Sepia</option>
                    <option value="blur(10px)">Blur</option>
                    <option value="invert(100%)">Invert</option>
                    <option value="fade">Cross Fade</option>
                </select>
            </div>

            <div id="text-fields" style="display:none">
                <div class="field"><label>Text Content</label><input type="text" id="inspectText"></div>
                <div style="display:flex; gap:10px">
                    <div class="field" style="flex:1"><label>Fill</label><input type="color" id="inspectColor"></div>
                    <div class="field" style="flex:1"><label>Stroke</label><input type="color" id="inspectStrokeColor"></div>
                </div>
                <div style="display:flex; gap:10px">
                    <div class="field" style="flex:1"><label>X Pos</label><input type="number" id="inspectX"></div>
                    <div class="field" style="flex:1"><label>Y Pos</label><input type="number" id="inspectY"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="timeline-section">
    <div id="timeline-header">
        <div id="playhead-handle-area" style="position:relative; width:100%; height:100%;">
            <div id="playhead-container" style="position:absolute; height:1000px; width:2px; top:10px;">
                <div id="playhead-handle"></div>
                <div id="playhead"></div>
            </div>
        </div>
    </div>
    <div id="timeline-content">
        <div class="track" id="textTrack"></div>
        <div class="track" id="videoTrack"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const playhead = document.getElementById('playhead-container');
    const speedRange = document.getElementById('speedRange');
    const speedVal = document.getElementById('speedVal');
    
    let clips = [];
    let selectedClip = null;
    let currentTime = 0;
    let isPlaying = false;
    let playbackRate = 1.0;
    let pixelsPerSecond = 50;

    // --- „ÇØ„É™„ÉÉ„ÉóÁÆ°ÁêÜ„ÇØ„É©„Çπ ---
    class Clip {
        constructor(id, type, source, duration, trackId) {
            this.id = id;
            this.type = type;
            this.source = source;
            this.start = 0;
            this.duration = duration;
            this.offset = 0;
            this.trackId = trackId;
            this.effect = "none";
            // ÈÖçÁΩÆ„Éª„Éá„Ç∂„Ç§„É≥
            this.text = "New Text";
            this.x = 640; this.y = 360; // ÂàùÊúüÂ∫ßÊ®ô
            this.color = "#ffffff";
            this.strokeColor = "#000000";
            this.dom = this.createDOM();
        }

        createDOM() {
            const div = document.createElement('div');
            div.className = `clip ${this.type}`;
            div.innerHTML = `<span></span><div class="handle-r"></div>`;
            div.addEventListener('pointerdown', (e) => selectClip(this, e));
            
            // Èï∑„ÅïË™øÁØÄ
            div.querySelector('.handle-r').addEventListener('pointerdown', (e) => {
                e.stopPropagation();
                let startX = e.clientX;
                let startDur = this.duration;
                const onMove = (me) => {
                    this.duration = Math.max(0.2, startDur + (me.clientX - startX) / pixelsPerSecond);
                    this.updateUI(); render();
                };
                window.addEventListener('pointermove', onMove);
                window.addEventListener('pointerup', () => window.removeEventListener('pointermove', onMove), {once:true});
            });
            return div;
        }

        updateUI() {
            this.dom.style.left = (this.start * pixelsPerSecond) + "px";
            this.dom.style.width = (this.duration * pixelsPerSecond) + "px";
            this.dom.querySelector('span').innerText = this.type === 'video' ? 'üé¨ Video' : 'È°å ' + this.text;
        }
    }

    // --- „Éó„É¨„Éì„É•„Éº‰∏ä„Åß„ÅÆÊñáÂ≠ó„Éâ„É©„ÉÉ„Ç∞ ---
    let isDraggingText = false;
    canvas.addEventListener('pointerdown', (e) => {
        if (!selectedClip || selectedClip.type !== 'text') return;
        
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const mouseX = (e.clientX - rect.left) * scaleX;
        const mouseY = (e.clientY - rect.top) * scaleY;

        // Âà§ÂÆöÔºàÁ∞°ÊòìÁöÑ„Å´ÊñáÂ≠ó‰ªòËøë„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºâ
        if (Math.abs(mouseX - selectedClip.x) < 200 && Math.abs(mouseY - selectedClip.y) < 100) {
            isDraggingText = true;
            const onMove = (me) => {
                selectedClip.x = (me.clientX - rect.left) * scaleX;
                selectedClip.y = (me.clientY - rect.top) * scaleY;
                updateInspectorFields();
                render();
            };
            window.addEventListener('pointermove', onMove);
            window.addEventListener('pointerup', () => {
                isDraggingText = false;
                window.removeEventListener('pointermove', onMove);
            }, {once:true});
        }
    });

    // --- ÂÜçÁîü„Éò„ÉÉ„Éâ„ÅÆ„Éâ„É©„ÉÉ„Ç∞ ---
    const phHandle = document.getElementById('playhead-handle');
    phHandle.onpointerdown = (e) => {
        isPlaying = false;
        const onMove = (me) => {
            const rect = document.getElementById('timeline-header').getBoundingClientRect();
            currentTime = Math.max(0, (me.clientX - rect.left) / pixelsPerSecond);
            render();
        };
        window.addEventListener('pointermove', onMove);
        window.addEventListener('pointerup', () => window.removeEventListener('pointermove', onMove), {once:true});
    };

    // --- Á¥†Êùê„Ç§„É≥„Éù„Éº„Éà ---
    document.getElementById('fileVideo').onchange = async (e) => {
        for (let file of e.target.files) {
            const v = document.createElement('video');
            v.src = URL.createObjectURL(file);
            v.muted = true;
            await new Promise(r => v.onloadedmetadata = r);
            const clip = new Clip(Date.now(), 'video', v, v.duration, 'videoTrack');
            clip.start = clips.length > 0 ? currentTime : 0;
            clips.push(clip);
            document.getElementById(clip.trackId).appendChild(clip.dom);
            clip.updateUI();
            addLibraryItem(file.name);
        }
        render();
    };

    function addLibraryItem(name) {
        const item = document.createElement('div');
        item.style.padding = "8px";
        item.style.borderBottom = "1px solid var(--border)";
        item.innerText = "üé¨ " + name;
        document.getElementById('mediaList').appendChild(item);
        document.getElementById('mediaStats').innerText = `ÂãïÁîª: ${document.getElementById('mediaList').children.length}Êú¨`;
    }

    function addText() {
        const clip = new Clip(Date.now(), 'text', null, 5, 'textTrack');
        clip.start = currentTime;
        clips.push(clip);
        document.getElementById(clip.trackId).appendChild(clip.dom);
        clip.updateUI();
        render();
    }

    // --- „Ç§„É≥„Çπ„Éö„ÇØ„ÇøÈÄ£Êê∫ ---
    function selectClip(clip, e) {
        if(e) e.stopPropagation();
        if (selectedClip) selectedClip.dom.classList.remove('selected');
        selectedClip = clip;
        clip.dom.classList.add('selected');

        document.getElementById('no-selection').style.display = 'none';
        document.getElementById('controls').style.display = 'block';
        document.getElementById('text-fields').style.display = clip.type === 'text' ? 'block' : 'none';
        updateInspectorFields();
    }

    function updateInspectorFields() {
        if(!selectedClip) return;
        document.getElementById('inspectEffect').value = selectedClip.effect;
        if(selectedClip.type === 'text') {
            document.getElementById('inspectText').value = selectedClip.text;
            document.getElementById('inspectColor').value = selectedClip.color;
            document.getElementById('inspectStrokeColor').value = selectedClip.strokeColor;
            document.getElementById('inspectX').value = Math.round(selectedClip.x);
            document.getElementById('inspectY').value = Math.round(selectedClip.y);
        }
    }

    document.querySelectorAll('#inspector-panel input, #inspector-panel select').forEach(el => {
        el.oninput = (e) => {
            if(!selectedClip) return;
            const val = e.target.value;
            switch(e.target.id) {
                case 'inspectEffect': selectedClip.effect = val; break;
                case 'inspectText': selectedClip.text = val; break;
                case 'inspectColor': selectedClip.color = val; break;
                case 'inspectStrokeColor': selectedClip.strokeColor = val; break;
                case 'inspectX': selectedClip.x = parseFloat(val); break;
                case 'inspectY': selectedClip.y = parseFloat(val); break;
            }
            selectedClip.updateUI();
            render();
        };
    });

    // --- ÊèèÁîª„Ç®„É≥„Ç∏„É≥ ---
    function render() {
        if (canvas.width !== 1280) { canvas.width = 1280; canvas.height = 720; }
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const activeClips = clips.filter(c => currentTime >= c.start && currentTime <= c.start + c.duration);
        
        activeClips.forEach(clip => {
            ctx.save();
            if (clip.effect === 'fade') {
                let alpha = 1;
                const inT = currentTime - clip.start;
                const outT = (clip.start + clip.duration) - currentTime;
                alpha = Math.min(1, inT/0.5, outT/0.5);
                ctx.globalAlpha = alpha;
            } else if (clip.effect !== 'none') {
                ctx.filter = clip.effect;
            }

            if (clip.type === 'video') {
                clip.source.currentTime = clip.offset + (currentTime - clip.start);
                ctx.drawImage(clip.source, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.font = "bold 80px sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.strokeStyle = clip.strokeColor;
                ctx.lineWidth = 10;
                ctx.strokeText(clip.text, clip.x, clip.y);
                ctx.fillStyle = clip.color;
                ctx.fillText(clip.text, clip.x, clip.y);
            }
            ctx.restore();
        });
        playhead.style.left = (currentTime * pixelsPerSecond) + "px";
    }

    // --- ÂÆüË°åÁ≥ª ---
    speedRange.oninput = () => {
        playbackRate = parseFloat(speedRange.value);
        speedVal.innerText = playbackRate.toFixed(1) + "x";
    };

    document.getElementById('btnPlay').onclick = () => {
        isPlaying = !isPlaying;
        document.getElementById('btnPlay').classList.toggle('active', isPlaying);
        if (isPlaying) {
            let lastTime = performance.now();
            const loop = (now) => {
                if (!isPlaying) return;
                const dt = (now - lastTime) / 1000;
                lastTime = now;
                currentTime += dt * playbackRate;
                render();
                requestAnimationFrame(loop);
            };
            requestAnimationFrame(loop);
        }
    };

    document.getElementById('btnSplit').onclick = () => {
        if (!selectedClip || selectedClip.type !== 'video') return;
        const splitPoint = currentTime - selectedClip.start;
        if (splitPoint <= 0.2 || splitPoint >= selectedClip.duration - 0.2) return;
        const newClip = new Clip(Date.now(), 'video', selectedClip.source, selectedClip.duration - splitPoint, 'videoTrack');
        newClip.start = currentTime;
        newClip.offset = selectedClip.offset + splitPoint;
        selectedClip.duration = splitPoint;
        clips.push(newClip);
        document.getElementById(newClip.trackId).appendChild(newClip.dom);
        selectedClip.updateUI(); newClip.updateUI(); render();
    };

    // „ÇØ„É™„ÉÉ„ÉóÁßªÂãï
    window.addEventListener('pointermove', (e) => {
        if (selectedClip && e.buttons === 1 && e.target === selectedClip.dom && !isDraggingText) {
            const rect = document.getElementById('timeline-content').getBoundingClientRect();
            selectedClip.start = Math.max(0, (e.clientX - rect.left) / pixelsPerSecond);
            selectedClip.updateUI(); render();
        }
    });
</script>
</body>
</html>
