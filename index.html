<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Video Editor Pro - Effects & Drag</title>
    <style>
        :root { --bg: #1a1a1a; --panel: #2d2d2d; --accent: #00a2ff; --text: #eee; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; touch-action: none; }

        /* ä¸Šéƒ¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        #top-panel { display: flex; flex: 1; min-height: 0; border-bottom: 2px solid #000; }
        #library-panel { width: 180px; background: var(--panel); border-right: 1px solid #111; padding: 10px; overflow-y: auto; font-size: 12px; }
        #preview-container { flex: 2; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        canvas { max-width: 95%; max-height: 85%; background: #111; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #inspector-panel { width: 240px; background: var(--panel); border-left: 1px solid #111; padding: 15px; overflow-y: auto; font-size: 13px; }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        #timeline-outer { height: 320px; background: #222; overflow-x: auto; position: relative; border-top: 1px solid #444; }
        #timeline-content { position: relative; width: 5000px; height: 100%; padding-top: 40px; }
        #time-ruler { position: absolute; top: 0; left: 0; height: 30px; background: #333; width: 100%; border-bottom: 1px solid #444; }
        .track { height: 70px; border-bottom: 1px solid #333; position: relative; width: 100%; display: flex; align-items: center; }
        
        /* ã‚¯ãƒªãƒƒãƒ— */
        .clip { position: absolute; height: 55px; background: var(--accent); border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); overflow: hidden; cursor: move; touch-action: none; display: flex; align-items: center; padding: 0 10px; color: white; font-size: 11px; }
        .clip.text { background: #673ab7; }
        .clip.selected { outline: 3px solid #fff; z-index: 10; }
        .handle-r { position: absolute; right: 0; top: 0; bottom: 0; width: 15px; background: rgba(0,0,0,0.2); cursor: col-resize; }

        /* å†ç”Ÿãƒ˜ãƒƒãƒ‰ï¼ˆæ”¹è‰¯ç‰ˆï¼‰ */
        #playhead-container { position: absolute; top: 0; bottom: 0; width: 30px; margin-left: -15px; z-index: 1000; cursor: grab; touch-action: none; }
        #playhead-line { position: absolute; left: 15px; top: 30px; bottom: 0; width: 2px; background: #ff3b30; pointer-events: none; }
        #playhead-handle { position: absolute; left: 0; top: 0; width: 30px; height: 30px; background: #ff3b30; clip-path: polygon(0% 0%, 100% 0%, 100% 60%, 50% 100%, 0% 60%); }

        /* UIè¦ç´  */
        .btn { background: #444; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; width: 100%; margin-bottom: 10px; font-size: 12px; }
        .btn:active { background: var(--accent); }
        .group { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #444; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 11px; }
        select, input[type="text"] { width: 100%; background: #111; color: white; border: 1px solid #555; padding: 5px; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="top-panel">
    <div id="library-panel">
        <p><b>LIBRARY</b></p>
        <div id="videoStats">å‹•ç”»: 0æœ¬</div>
        <div id="mediaList" style="color: #888; margin-bottom: 15px;"></div>
        <button class="btn" onclick="document.getElementById('fileVideo').click()">+ å‹•ç”»è¿½åŠ </button>
        <button class="btn" onclick="addText()">+ ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ </button>
        <input type="file" id="fileVideo" hidden accept="video/*" multiple>
    </div>

    <div id="preview-container">
        <canvas id="mainCanvas"></canvas>
        <div style="margin-top:15px; display:flex; gap:20px;">
            <button class="btn" id="btnPlay" style="width:120px; font-weight:bold;">å†ç”Ÿ / åœæ­¢</button>
            <button class="btn" id="btnSplit" style="background:#d32f2f; width:120px;">ã“ã“ã‚’åˆ†å‰²</button>
        </div>
    </div>
    
    <div id="inspector-panel">
        <p><b>INSPECTOR</b></p>
        <div id="no-selection" style="color:#666">ã‚¯ãƒªãƒƒãƒ—ã‚’é¸æŠ</div>
        
        <div id="controls" style="display:none">
            <div class="group">
                <label>ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé¸æŠ</label>
                <select id="inspectEffect">
                    <option value="none">ãªã—</option>
                    <option value="grayscale(100%)">ãƒ¢ãƒã‚¯ãƒ­</option>
                    <option value="sepia(100%)">ã‚»ãƒ”ã‚¢</option>
                    <option value="blur(10px)">ãƒ–ãƒ©ãƒ¼(ã¼ã‹ã—)</option>
                    <option value="invert(100%)">åè»¢</option>
                    <option value="fade">ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ»ã‚¢ã‚¦ãƒˆ</option>
                </select>
            </div>

            <div id="text-only" style="display:none">
                <div class="group">
                    <label>ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹</label>
                    <input type="text" id="inspectText">
                </div>
                <div class="group">
                    <label>æ–‡å­—è‰² / æ ç·šè‰²</label>
                    <input type="color" id="inspectColor" style="width:48%">
                    <input type="color" id="inspectStrokeColor" style="width:48%">
                </div>
            </div>
        </div>

        <button id="btnExport" class="btn" style="margin-top:20px; background: #0078d4;">WebMã§ä¿å­˜</button>
    </div>
</div>

<div id="timeline-outer">
    <div id="timeline-content">
        <div id="time-ruler"></div>
        <!-- å†ç”Ÿãƒ˜ãƒƒãƒ‰ -->
        <div id="playhead-container">
            <div id="playhead-handle"></div>
            <div id="playhead-line"></div>
        </div>
        <div class="track" id="textTrack"></div>
        <div class="track" id="videoTrack"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const timelineContent = document.getElementById('timeline-content');
    const playhead = document.getElementById('playhead-container');
    
    let clips = [];
    let selectedClip = null;
    let currentTime = 0;
    let isPlaying = false;
    let pixelsPerSecond = 50;

    // --- ã‚¯ãƒªãƒƒãƒ—ç®¡ç† ---
    class Clip {
        constructor(id, type, source, duration, trackId) {
            this.id = id;
            this.type = type;
            this.source = source;
            this.start = 0;
            this.duration = duration;
            this.offset = 0;
            this.trackId = trackId;
            this.effect = "none";
            this.text = "New Text";
            this.color = "#ffffff";
            this.strokeColor = "#000000";
            this.dom = this.createDOM();
        }

        createDOM() {
            const div = document.createElement('div');
            div.className = `clip ${this.type}`;
            div.innerHTML = `<span></span><div class="handle-r"></div>`;
            div.addEventListener('pointerdown', (e) => selectClip(this, e));
            
            // å³ç«¯ãƒ‰ãƒ©ãƒƒã‚°
            const handle = div.querySelector('.handle-r');
            handle.addEventListener('pointerdown', (e) => {
                e.stopPropagation();
                let startX = e.clientX;
                let startDur = this.duration;
                const onMove = (me) => {
                    this.duration = Math.max(0.2, startDur + (me.clientX - startX) / pixelsPerSecond);
                    this.updateUI(); render();
                };
                const onUp = () => { window.removeEventListener('pointermove', onMove); };
                window.addEventListener('pointermove', onMove);
                window.addEventListener('pointerup', onUp, {once:true});
            });
            return div;
        }

        updateUI() {
            this.dom.style.left = (this.start * pixelsPerSecond) + "px";
            this.dom.style.width = (this.duration * pixelsPerSecond) + "px";
            this.dom.querySelector('span').innerText = this.type === 'video' ? 'Video' : this.text;
        }
    }

    // --- å†ç”Ÿãƒ˜ãƒƒãƒ‰ã®ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ ---
    playhead.onpointerdown = (e) => {
        isPlaying = false; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯å†ç”Ÿåœæ­¢
        const startX = e.clientX;
        const startPos = currentTime * pixelsPerSecond;
        
        const onMove = (me) => {
            const diff = me.clientX - startX;
            const newPos = Math.max(0, startPos + diff);
            currentTime = newPos / pixelsPerSecond;
            playhead.style.left = newPos + "px";
            render();
        };
        const onUp = () => { window.removeEventListener('pointermove', onMove); };
        window.addEventListener('pointermove', onMove);
        window.addEventListener('pointerup', onUp, {once:true});
    };

    // --- ç´ æè¿½åŠ  ---
    document.getElementById('fileVideo').onchange = async (e) => {
        for (let file of e.target.files) {
            const v = document.createElement('video');
            v.src = URL.createObjectURL(file);
            v.muted = true;
            await new Promise(r => v.onloadedmetadata = r);
            const clip = new Clip(Date.now(), 'video', v, v.duration, 'videoTrack');
            clip.start = currentTime;
            clips.push(clip);
            document.getElementById(clip.trackId).appendChild(clip.dom);
            clip.updateUI();
            updateMediaList(file.name);
        }
        render();
    };

    function updateMediaList(name) {
        const list = document.getElementById('mediaList');
        const stats = document.getElementById('videoStats');
        const count = list.children.length + 1;
        stats.innerText = `å‹•ç”»: ${count}æœ¬`;
        const item = document.createElement('div');
        item.innerText = `ğŸ¬ ${name}`;
        list.appendChild(item);
    }

    function addText() {
        const clip = new Clip(Date.now(), 'text', null, 5, 'textTrack');
        clip.start = currentTime;
        clips.push(clip);
        document.getElementById(clip.trackId).appendChild(clip.dom);
        clip.updateUI();
        render();
    }

    // --- ã‚¤ãƒ³ã‚¹ãƒšã‚¯ã‚¿æ›´æ–° ---
    function selectClip(clip, e) {
        if(e) e.stopPropagation();
        if (selectedClip) selectedClip.dom.classList.remove('selected');
        selectedClip = clip;
        clip.dom.classList.add('selected');

        document.getElementById('no-selection').style.display = 'none';
        document.getElementById('controls').style.display = 'block';
        document.getElementById('text-only').style.display = clip.type === 'text' ? 'block' : 'none';
        
        document.getElementById('inspectEffect').value = clip.effect;
        if(clip.type === 'text') {
            document.getElementById('inspectText').value = clip.text;
            document.getElementById('inspectColor').value = clip.color;
            document.getElementById('inspectStrokeColor').value = clip.strokeColor;
        }
    }

    // è¨­å®šå¤‰æ›´ã®åæ˜ 
    document.querySelectorAll('#inspector-panel input, #inspector-panel select').forEach(el => {
        el.oninput = (e) => {
            if(!selectedClip) return;
            const id = e.target.id;
            const val = e.target.value;
            if(id === 'inspectEffect') selectedClip.effect = val;
            if(id === 'inspectText') selectedClip.text = val;
            if(id === 'inspectColor') selectedClip.color = val;
            if(id === 'inspectStrokeColor') selectedClip.strokeColor = val;
            selectedClip.updateUI();
            render();
        };
    });

    // --- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (åˆæˆæç”») ---
    function render() {
        if (canvas.width !== 1280) { canvas.width = 1280; canvas.height = 720; }
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const activeClips = clips.filter(c => currentTime >= c.start && currentTime <= c.start + c.duration);
        
        activeClips.forEach(clip => {
            ctx.save();
            
            // 1. ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé©ç”¨
            if (clip.effect === 'fade') {
                let alpha = 1;
                const inTime = currentTime - clip.start;
                const outTime = (clip.start + clip.duration) - currentTime;
                if(inTime < 0.8) alpha = inTime / 0.8;
                if(outTime < 0.8) alpha = Math.min(alpha, outTime / 0.8);
                ctx.globalAlpha = alpha;
            } else if (clip.effect !== 'none') {
                ctx.filter = clip.effect;
            }

            // 2. æç”»
            if (clip.type === 'video') {
                clip.source.currentTime = clip.offset + (currentTime - clip.start);
                ctx.drawImage(clip.source, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.font = "bold 80px Arial";
                ctx.textAlign = "center";
                ctx.strokeStyle = clip.strokeColor;
                ctx.lineWidth = 6;
                ctx.strokeText(clip.text, canvas.width/2, canvas.height/2);
                ctx.fillStyle = clip.color;
                ctx.fillText(clip.text, canvas.width/2, canvas.height/2);
            }
            ctx.restore();
        });
        playhead.style.left = (currentTime * pixelsPerSecond) + "px";
    }

    // --- å®Ÿè¡Œç³» ---
    document.getElementById('btnPlay').onclick = () => {
        isPlaying = !isPlaying;
        if (isPlaying) {
            const loop = () => {
                if (!isPlaying) return;
                currentTime += 0.033;
                render();
                requestAnimationFrame(loop);
            };
            loop();
        }
    };

    document.getElementById('btnSplit').onclick = () => {
        if (!selectedClip || selectedClip.type !== 'video') return;
        const splitPoint = currentTime - selectedClip.start;
        if (splitPoint <= 0.2 || splitPoint >= selectedClip.duration - 0.2) return;
        const newClip = new Clip(Date.now(), 'video', selectedClip.source, selectedClip.duration - splitPoint, 'videoTrack');
        newClip.start = currentTime;
        newClip.offset = selectedClip.offset + splitPoint;
        selectedClip.duration = splitPoint;
        clips.push(newClip);
        document.getElementById(newClip.trackId).appendChild(newClip.dom);
        selectedClip.updateUI(); newClip.updateUI(); render();
    };

    // ã‚¯ãƒªãƒƒãƒ—ç§»å‹•ãƒ‰ãƒ©ãƒƒã‚°
    window.addEventListener('pointermove', (e) => {
        if (selectedClip && e.buttons === 1 && e.target === selectedClip.dom) {
            const rect = timelineContent.getBoundingClientRect();
            selectedClip.start = Math.max(0, (e.clientX - rect.left) / pixelsPerSecond);
            selectedClip.updateUI(); render();
        }
    });
</script>
</body>
</html>
